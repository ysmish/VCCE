<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project.name }} - Collaborative C Code Editor</title>
    <!-- External CSS and JS libraries -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/clike/clike.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/selection/mark-selection.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/anyword-hint.min.js"></script>
    <!-- Inline styles for editor layout and design -->
    <style>
        /* Custom styles for the input container */
        .input-container {
            background-color: #f7f9fc;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            margin-top: 10px;
            border-radius: 0 0 5px 5px;
        }
        
        .input-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .input-container textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            margin-bottom: 10px;
            resize: vertical;
            min-height: 80px;
        }
        
        /* Adjust results panel layout */
        .result-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .output-area {
            flex: 1;
            overflow: auto;
            padding-bottom: 10px;
        }
        
        /* Make sure panel heights are appropriate */
        .results-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .output-content {
            height: auto !important;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Header section with project title and user info -->
    <div class="header">
        <h1>{{ project.name }} <span class="project-subtitle">Collaborative C Code Editor</span></h1>
        <div class="user-info">
            <span id="current-username">{{ username }}</span>
            <a href="{{ url_for('dashboard') }}" class="btn dashboard-btn">Dashboard</a>
            <a href="{{ url_for('logout') }}" class="btn logout-btn">Logout</a>
        </div>
    </div>

    <!-- Main container for sidebar and content -->
    <div class="main-container">
        <!-- Sidebar with project info, active users, and chat -->
        <div class="sidebar">
            <div class="project-info">
                <h3>Project Details</h3>
                <div class="project-details">
                    <p><strong>Owner:</strong> <span id="project-owner">{{ owner_username }}</span></p>
                    <p><strong>Created:</strong> {{ project.created_at.strftime('%Y-%m-%d') }}</p>
                    <p><strong>Last Updated:</strong> <span id="last-updated">{{ project.updated_at.strftime('%Y-%m-%d %H:%M') }}</span></p>
                </div>
                
                {% if project.owner_id == session.user_id %}
                <div class="collaborators-section">
                    <h4>Invite Collaborator</h4>
                    <form id="invite-form" action="{{ url_for('invite_collaborator', project_id=project.id) }}" method="post">
                        <div class="form-group">
                            <input type="text" id="collaborator-username" name="username" placeholder="Username" required>
                        </div>
                        <button type="submit" class="btn invite-btn">
                            <i class="fas fa-user-plus"></i> Invite
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
            
            <div class="active-users">
                <h3>Connected Users</h3>
                <ul id="users-list"></ul>
            </div>
            
            <div class="chat-container">
                <h3>Project Chat</h3>
                <div id="chat-messages" class="chat-messages"></div>
                <form id="chat-form" class="chat-form">
                    <input type="text" id="chat-input" placeholder="Type a message..." required>
                    <button type="submit" class="btn send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Content container for editor and results -->
        <div class="content-container">
            <div class="editor-container">
                <div class="editor-options">
                    <div class="language-info">
                        <span>Language: C</span>
                    </div>
                    <div class="editor-actions">
                        <button id="compile-button" class="btn action-btn compile-btn">
                            <i class="fas fa-cogs"></i> Compile
                        </button>
                        <button id="run-button" class="btn action-btn run-btn">
                            <i class="fas fa-play"></i> Run
                        </button>
                        <button id="save-button" class="btn action-btn save-btn">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button id="toggle-results" class="btn action-btn">
                            <i class="fas fa-columns"></i> Show Results
                        </button>
                    </div>
                </div>
                <textarea id="editor">{{ project.content }}</textarea>
            </div>

            <div class="results-container" style="display: none;">
                <div class="result-header">
                    <h3>Execution Results</h3>
                </div>
                <div id="output-tabs" class="output-tabs">
                    <div class="tab active" data-tab="compile-output">Compilation</div>
                    <div class="tab" data-tab="stdout-output">Standard Output</div>
                    <div class="tab" data-tab="stderr-output">Standard Error</div>
                </div>
                
                <div id="result-panel" class="result-panel">
                    <div id="loading-spinner" class="loading-spinner" style="display: none;">
                        <div class="spinner"></div>
                    </div>
                    
                    <div class="output-area">
                        <div id="compile-output" class="output-content"></div>
                        <div id="stdout-output" class="output-content" style="display: none;"></div>
                        <div id="stderr-output" class="output-content" style="display: none;"></div>
                    </div>
                    
                    <!-- Program Input Container - Always visible but toggled by JS -->
                    <div id="input-container" class="input-container" style="display: none;">
                        <label for="program-input"><i class="fas fa-keyboard"></i> Program Input:</label>
                        <textarea id="program-input" rows="4" placeholder="Enter input for your program here..."></textarea>
                        <button id="run-with-input-btn" class="btn action-btn run-btn">
                            <i class="fas fa-play"></i> Run with Input
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for editor and collaboration functionality -->
    <script>
        // Global variables
        let editor;
        let socket;
        let activeUsers = new Map();
        let executionInProgress = false;
        const projectId = "{{ project.id }}";
        const currentUserId = "{{ session.user_id }}";
        const currentUsername = "{{ username }}";
        let userCursors = {};  // Store other users' cursor positions
        let userColors = {};   // Store colors for each user

        // Generate a color based on username
        function generateUserColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            // Generate bright, distinct colors
            const hue = hash % 360;
            return `hsl(${hue}, 70%, 50%)`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            initializeSocketConnection();
            initializeUIEvents();
        });

        function initializeEditor() {
            const editorElement = document.getElementById('editor');
            
            editor = CodeMirror.fromTextArea(editorElement, {
                lineNumbers: true,
                mode: 'text/x-csrc',
                theme: 'default',
                indentUnit: 4,
                indentWithTabs: true,
                lineWrapping: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                extraKeys: {
                    "Ctrl-Enter": function() {
                        runCode();
                    },
                    "Ctrl-S": function() {
                        saveCode();
                        return false;
                    },
                    "Ctrl-Space": "autocomplete"
                }
            });

            editor.setSize(null, "80vh");

            editor.on('change', function(instance, changeObj) {
                if (changeObj.origin !== 'setValue' && changeObj.origin !== 'socket') {
                    let operation;
                    if (changeObj.origin === '+input' || changeObj.origin === 'paste') {
                        operation = {
                            type: 'insert',
                            position: editor.indexFromPos(changeObj.from),
                            text: changeObj.text.join('\n'),
                            project_id: projectId
                        };
                    } else if (changeObj.origin === '+delete' || changeObj.origin === 'cut') {
                        operation = {
                            type: 'delete',
                            position: editor.indexFromPos(changeObj.from),
                            length: changeObj.removed.join('\n').length,
                            project_id: projectId
                        };
                    }
                    
                    if (operation) {
                        socket.emit('edit', operation);
                    }
                }
            });
        }

        function initializeSocketConnection() {
            socket = io();
            
            socket.on('connect', function() {
                socket.emit('join', { project_id: projectId, user_id: currentUserId, username: currentUsername });
            });
            
            socket.on('user_joined', function(data) {
                activeUsers.set(data.user_id, data.username);
                updateUsersList();
                userColors[data.user_id] = generateUserColor(data.username);
            });
            
            socket.on('user_left', function(data) {
                activeUsers.delete(data.user_id);
                updateUsersList();
                delete userCursors[data.user_id];
                delete userColors[data.user_id];
            });
            
            socket.on('edit', function(operation) {
                if (operation.project_id === projectId) {
                    const pos = editor.posFromIndex(operation.position);
                    if (operation.type === 'insert') {
                        editor.replaceRange(operation.text, pos, null, 'socket');
                    } else if (operation.type === 'delete') {
                        const endPos = editor.posFromIndex(operation.position + operation.length);
                        editor.replaceRange('', pos, endPos, 'socket');
                    }
                }
            });
            
            socket.on('cursor_move', function(data) {
                if (data.user_id !== currentUserId && activeUsers.has(data.user_id)) {
                    userCursors[data.user_id] = data.position;
                    updateCursors();
                }
            });
            
            socket.on('chat_message', function(data) {
                appendChatMessage(data.username, data.message);
            });
        }

        function initializeUIEvents() {
            document.getElementById('compile-button').addEventListener('click', compileCode);
            document.getElementById('run-button').addEventListener('click', runCode);
            document.getElementById('save-button').addEventListener('click', saveCode);
            document.getElementById('toggle-results').addEventListener('click', toggleResults);
            document.getElementById('run-with-input-btn').addEventListener('click', runWithInput);
            
            document.getElementById('chat-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                if (message) {
                    socket.emit('chat_message', { project_id: projectId, message: message });
                    input.value = '';
                }
            });
            
            document.getElementById('invite-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const input = document.getElementById('collaborator-username');
                const username = input.value.trim();
                if (username) {
                    fetch(`/project/${projectId}/invite`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: username })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Collaborator invited successfully', 'success');
                        } else {
                            showNotification(data.error, 'error');
                        }
                    })
                    .catch(error => {
                        showNotification('Error inviting collaborator', 'error');
                    });
                    input.value = '';
                }
            });
        }

        function updateUsersList() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            activeUsers.forEach((username, userId) => {
                const li = document.createElement('li');
                li.textContent = username;
                if (userId === currentUserId) {
                    li.classList.add('current-user');
                }
                usersList.appendChild(li);
            });
        }

        function updateCursors() {
            editor.getAllMarks().forEach(mark => mark.clear());
            Object.entries(userCursors).forEach(([userId, position]) => {
                if (activeUsers.has(userId)) {
                    const pos = editor.posFromIndex(position);
                    const cursor = document.createElement('div');
                    cursor.className = 'remote-cursor';
                    cursor.style.backgroundColor = userColors[userId];
                    cursor.textContent = activeUsers.get(userId);
                    editor.addWidget(pos, cursor, false);
                }
            });
        }

        function appendChatMessage(username, message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `<strong>${username}:</strong> ${message}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function compileCode() {
            if (executionInProgress) return;
            executionInProgress = true;
            
            const compileButton = document.getElementById('compile-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            compileButton.disabled = true;
            compileButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Compiling...';
            loadingSpinner.style.display = 'block';
            
            document.getElementById('compile-output').textContent = '';
            document.getElementById('stdout-output').textContent = '';
            document.getElementById('stderr-output').textContent = '';
            
            fetch(`/project/${projectId}/compile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: editor.getValue() })
            })
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    document.getElementById('compile-output').textContent = 'Compilation successful!';
                    showNotification('Compilation successful', 'success');
                } else {
                    document.getElementById('compile-output').textContent = data.error || 'Compilation failed';
                    showNotification('Compilation failed', 'error');
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                document.getElementById('compile-output').textContent = 'Error: ' + error.message;
                showNotification('Compilation error', 'error');
            })
            .finally(() => {
                compileButton.disabled = false;
                compileButton.innerHTML = '<i class="fas fa-cogs"></i> Compile';
                executionInProgress = false;
            });
        }

        function runCode() {
            if (executionInProgress) return;
            executionInProgress = true;
            
            const runButton = document.getElementById('run-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            runButton.disabled = true;
            runButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            loadingSpinner.style.display = 'block';
            
            document.getElementById('compile-output').textContent = '';
            document.getElementById('stdout-output').textContent = '';
            document.getElementById('stderr-output').textContent = '';
            
            fetch(`/project/${projectId}/run`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: editor.getValue() })
            })
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    document.getElementById('stdout-output').textContent = data.output || 'No output';
                    document.getElementById('stderr-output').textContent = data.error || '';
                    showNotification('Execution successful', 'success');
                } else {
                    document.getElementById('stderr-output').textContent = data.error || 'Execution failed';
                    showNotification('Execution failed', 'error');
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                document.getElementById('stderr-output').textContent = 'Error: ' + error.message;
                showNotification('Execution error', 'error');
            })
            .finally(() => {
                runButton.disabled = false;
                runButton.innerHTML = '<i class="fas fa-play"></i> Run';
                executionInProgress = false;
            });
        }

        function saveCode() {
            const saveButton = document.getElementById('save-button');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            fetch(`/project/${projectId}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: editor.getValue() })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Code saved successfully', 'success');
                    document.getElementById('last-updated').textContent = new Date().toLocaleString();
                } else {
                    showNotification('Error saving code', 'error');
                }
            })
            .catch(error => {
                showNotification('Error saving code', 'error');
            })
            .finally(() => {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save';
            });
        }

        function toggleResults() {
            const resultsContainer = document.querySelector('.results-container');
            const toggleButton = document.getElementById('toggle-results');
            
            if (resultsContainer.style.display === 'none') {
                resultsContainer.style.display = 'block';
                toggleButton.innerHTML = '<i class="fas fa-columns"></i> Hide Results';
            } else {
                resultsContainer.style.display = 'none';
                toggleButton.innerHTML = '<i class="fas fa-columns"></i> Show Results';
            }
        }

        function runWithInput() {
            if (executionInProgress) return;
            executionInProgress = true;
            
            const runButton = document.getElementById('run-with-input-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const input = document.getElementById('program-input').value;
            
            runButton.disabled = true;
            runButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            loadingSpinner.style.display = 'block';
            
            document.getElementById('compile-output').textContent = '';
            document.getElementById('stdout-output').textContent = '';
            document.getElementById('stderr-output').textContent = '';
            
            fetch(`/project/${projectId}/run`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: editor.getValue(), input: input })
            })
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    document.getElementById('stdout-output').textContent = data.output || 'No output';
                    document.getElementById('stderr-output').textContent = data.error || '';
                    showNotification('Execution successful', 'success');
                } else {
                    document.getElementById('stderr-output').textContent = data.error || 'Execution failed';
                    showNotification('Execution failed', 'error');
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                document.getElementById('stderr-output').textContent = 'Error: ' + error.message;
                showNotification('Execution error', 'error');
            })
            .finally(() => {
                runButton.disabled = false;
                runButton.innerHTML = '<i class="fas fa-play"></i> Run with Input';
                executionInProgress = false;
            });
        }
    </script>
</body>
</html>